# GESP AI 产品需求文档 (PRD)

**版本**：v2.0
**更新日期**：2026年2月8日
**域名**：[GESP.AI](https://gesp.ai)
**部署平台**：Railway

---

## 一、产品概述

### 1.1 产品定位

**GESP AI 是一个 AI 原生的 GESP C++ 编程等级考试备考平台。**

- **AI 原生**：AI 是决策中枢，不是执行工具
- **AI 决定学什么** → 用户跟着执行（而非用户决定、AI 辅助）

| 功能 | 传统 AI 增强 | GESP AI（AI 原生） |
|------|------------|-------------------|
| 学习规划 | 用户选课程，AI 推荐 | AI 根据目标日期和当前水平，决定每天学什么 |
| 练习选题 | 用户找题，AI 讲解 | AI 根据薄弱点，决定该练哪道题 |
| 问题诊断 | 用户问才回答 | AI 主动发现"你 DFS 边界条件有问题" |
| 进度调整 | 用户自己决定加快/放慢 | AI 根据表现，动态调整计划 |

### 1.2 目标用户

备考 GESP C++ 1-8 级考试的小学生和初中生。

**第一用户**：

| 维度 | 信息 |
|------|------|
| 姓名 | 赵知行 |
| 年级 | 小学 5 年级 |
| 当前水平 | 已通过 GESP C++ 4 级（2025年12月） |
| 目标 | GESP C++ 5 级 |
| 考试日期 | 2026年3月14日 |

### 1.3 成功标准

赵知行在 2026 年 3 月 14 日通过 GESP 5 级考试 = MVP 验证成功。

---

## 二、核心原则

### 2.1 先教后引的教学方法论

1. **先给出核心概念的简明解释**（不让孩子猜基础定义）
2. **用可视化/比喻帮助理解**（迷宫图、生活例子）
3. **在关键决策点提问**（"你觉得下一步怎么做？"）
4. **允许孩子说"我不知道"**，给提示而不是继续追问
5. **保持正向反馈**（"对！""很接近了！""太棒了！"）

### 2.2 亲切老师的对话风格

| 场景 | 传统方式 | GESP AI |
|------|---------|---------|
| 解释 DFS | "深度优先搜索是一种遍历或搜索树或图的算法" | "DFS 就像走迷宫，选一条路一直走到底，走不通就退回来换条路试试！" |
| 代码错误 | "编译错误：缺少分号" | "哎呀，这行代码忘记加句号(分号)了，加上试试？" |
| 学生卡住 | "请仔细阅读题目" | "别着急～我们一起来看看题目在说什么，先找出关键信息好不好？" |
| AC 通过 | "Accepted" | "太厉害啦！一次就 AC 了！你今天已经超过 90% 的小朋友了！" |

---

## 三、功能模块

### 3.1 功能总览

| 模块 | 功能 | 状态 |
|------|------|------|
| 用户系统 | 注册/登录（用户名+密码，JWT 会话） | ✅ |
| 学习规划 | AI 根据目标+时间+做题表现生成个性化计划 | ✅ |
| 今日任务 | 首页显示 AI 决定的每日学习+练习任务 | ✅ |
| 知识点地图 | 1-8 级共 80 个知识点，按分类展示掌握度 | ✅ |
| AI 私教·学习 | 先教后引的交互式知识点讲解 | ✅ |
| AI 私教·验证 | 费曼学习法，学生讲解 + AI 追问 + 多维评估 | ✅ |
| 题库练习 | 184 道 GESP 官方真题，按级别/难度/知识点筛选 | ✅ |
| 在线评测 | Monaco 编辑器 + Judge0 判题（C++） | ✅ |
| AI 调试助手 | 渐进式三级提示（引导→定位→建议） | ✅ |
| 错题三问 | AI 诊断错误类型 + 三问复盘 + 防错规则生成 | ✅ |
| 模拟考试 | 模拟 GESP 真实考试（选择题+编程题，90分钟） | ✅ |
| 游戏化 | XP 经验值 + 连胜系统 + 7 种成就徽章 | ✅ |
| 语音输入 | 讯飞实时语音识别，支持中英文 | ✅ |
| AI 配置 | 用户自定义 4 种场景的 AI 提示词 | ✅ |
| 数据导入 | 洛谷数据导入 + 代码分析评估水平 | ✅ |
| 管理后台 | 题库同步 + 15 个系统提示词在线管理 | ✅ |

---

### 3.2 学习规划系统

**用户输入**（三步向导 `/setup`）：
1. 目标级别：GESP 1-8 级
2. 考试日期
3. 每周可用学习时间

**AI 输出**：
- 按周分配的知识点学习计划
- 每个知识点的预估学习时间
- 整体预计完成时间和通过概率

**智能特性**：
- 注入学生做题表现数据（正确率、薄弱知识点、常见错误类型），生成针对性计划
- 根据实际表现动态调整后续安排
- 临近考试时给出冲刺建议

---

### 3.3 今日任务（首页 `/dashboard`）

首页直接展示 AI 决定的今日任务，包含：
- 距考试倒计时、当前进度、预计通过率
- 今日任务列表（知识点学习 + 编程练习）
- 完成任务获得 XP 奖励，连胜 +1
- 全部完成触发庆祝动画（Three.js 3D 特效）

**AI 决策逻辑**：
1. 根据学习计划确定本周重点知识点
2. 优先安排：新知识点学习 > 练习巩固 > 错题复习
3. 昨天未完成任务优先补上

---

### 3.4 知识点学习（双模式）

| 路由 | 模式 | 说明 |
|------|------|------|
| `/learn/[topic]/tutor` | AI 私教·学习 | AI 以"赵老师"身份讲解知识点，先教后引 |
| `/learn/[topic]/feynman` | AI 私教·验证 | AI 以"李老师"（好奇学生）身份追问，验证理解深度 |

**费曼学习评估维度**：完整度、准确度、清晰度、薄弱点分析（5星评分）

**支持语音输入**：讯飞实时语音识别，空格键按住录音

---

### 3.5 题库与在线评测

**题库规模**：

| 级别 | 题目数 | 级别 | 题目数 |
|------|--------|------|--------|
| 1 级 | 26 题 | 5 级 | 22 题 |
| 2 级 | 26 题 | 6 级 | 22 题 |
| 3 级 | 24 题 | 7 级 | 20 题 |
| 4 级 | 24 题 | 8 级 | 20 题 |

**共 184 道 GESP 官方真题**，来源于洛谷（luogu.com.cn）GESP 题单。

**题目数据**：每道题包含完整题面、输入输出格式、样例、10-18 个测试用例（含边界测试）、知识点标签、难度等级、时间/内存限制。

**评测流程**：
```
用户编写代码（Monaco Editor）
  → 提交前自检（7 项防错规则检查）
  → Judge0 API 编译运行
  → 逐个测试点比对（AC/WA/TLE/CE/RE/MLE）
  → 失败时可请求 AI 调试助手
  → 可一键记录到错题本
```

**AI 调试助手**（渐进式三级提示）：
- 第 1 次：轻提示 — 引导思考，指出问题场景
- 第 2 次：中提示 — 定位具体代码行，说明原因
- 第 3 次+：详细提示 — 给出修改建议和关键代码片段

---

### 3.6 错题诊断系统

**核心流程**：提交失败 → 记录错题 → AI 分析错误类型 → 三问复盘 → 生成防错规则

**10 种错误类型**：

| 阶段 | 类型 | 标签 | 说明 |
|------|------|------|------|
| CE | syntax | 语法错误 | 代码无法编译 |
| RE | runtime | 运行崩溃 | 数组越界、除零、递归过深 |
| TLE | timeout | 效率不足 | 算法复杂度过高 |
| WA | misread | 审题疏漏 | 没看清题目条件 |
| WA | boundary | 边界遗漏 | 未处理特殊情况 |
| WA | careless | 粗心笔误 | 思路对但手误 |
| WA | uninit | 未初始化 | 变量未赋初值 |
| WA | logic | 逻辑错误 | 实现细节有漏洞 |
| WA | algorithm | 思路错误 | 算法方法本身错误 |
| WA | overflow | 数值溢出 | 整数范围超限 |

**三问复盘**（`/error-book/[id]`）：
1. **错了哪？** — AI 引导定位问题
2. **为什么错？** — AI 引导分析根因
3. **怎么避免？** — 总结防错策略

每一问都可请求 AI 提示。完成后自动生成防错规则。

**防错规则系统**（`/error-book/rules`）：
- 规则按错误类型分组，支持启用/停用/删除
- 记录触发次数，高频规则重点提醒
- 代码提交前自动检查是否违反已有规则

---

### 3.7 模拟考试

**路由**：`/mock-exam`

**考试结构**：
- 选择题：15 题 × 2 分 = 30 分
- 编程题：2 题 × 35 分 = 70 分
- 总分 100 分，60 分及格，限时 90 分钟

**页面功能**：
- SVG 圆形进度图展示预估通过率（基于 XP + 历史成绩）
- 考试记录列表（最近 5 次得分、通过/失败、分项得分、用时）
- 考前冲刺模式（距考试 ≤7 天自动激活）

---

### 3.8 游戏化激励体系

| 机制 | 说明 |
|------|------|
| XP 经验值 | 完成学习 +30 XP，AC 按难度 +10/20/30 XP，每日任务额外 +50 XP |
| 连胜系统 | 每日完成任务连胜 +1，超过 1 天未活跃归零 |
| 成就徽章 | 7 种徽章：初次 AC、7 天连胜、30 天连胜、500XP、1000XP、数论入门、搜索入门 |
| 庆祝动画 | 完成全部每日任务触发 Three.js 3D 特效 |

---

### 3.9 知识点体系

1-8 级共 **80 个知识点**，基于 CCF 官方考纲：

| 级别 | 知识点数 | 主要内容 |
|------|---------|---------|
| 1 级 | 10 | 计算机基础、C++ 程序框架、数据输入输出、基本数据类型 |
| 2 级 | 8 | 运算符、分支与循环、一维数组、函数基础 |
| 3 级 | 8 | 进制转换、位运算、二维数组、枚举与模拟 |
| 4 级 | 9 | 指针、结构体、函数进阶、递推、排序算法 |
| 5 级 | 11 | 数论（GCD/素数）、高精度、链表、二分、递归、贪心 |
| 6 级 | 14 | 树、DFS/BFS、动态规划、面向对象、栈与队列 |
| 7 级 | 10 | 数学函数、二维 DP、图论、哈希表 |
| 8 级 | 10 | 排列组合、最短路、最小生成树、算法优化 |

---

### 3.10 AI 提示词系统

**提示词优先级链**：用户自定义 > 管理员数据库设置 > 硬编码默认值

**15 个系统提示词**（3 类）：

| 分类 | 数量 | Key 列表 |
|------|------|---------|
| GESP AI 私教 | 4 | `learn-chat`（赵老师·学习）、`problem-chat`（钱老师·解题）、`problem-debug`（孙老师·调试）、`feynman-chat`（李老师·验证） |
| 错题诊断 | 6 | `error-classify`、`error-guide-q1`、`error-guide-q2`、`error-guide-q3`、`error-gen-rule`、`error-base` |
| 工具类 | 5 | `problem-error-analysis`、`feynman-question`、`plan-generate`、`review-import`、`review-prevention` |

**管理方式**：
- 管理后台（`/admin/prompts`）：在线编辑、对比默认值、恢复默认、批量初始化
- 用户端（`/profile/ai-config`）：自定义 4 个私教角色的提示词

---

### 3.11 数据导入

**路由**：`/import`

| 方式 | 说明 | 状态 |
|------|------|------|
| 洛谷数据导入 | 输入洛谷主页链接，解析做题记录，生成能力画像 | ✅ |
| 代码分析导入 | 粘贴 C++ 代码，AI 评估编程水平并推荐起始级别 | ✅ |
| 对话式信息采集 | AI 对话采集学习背景 | 🚧 UI 完成 |

---

### 3.12 管理后台

> **注意**：当前管理后台无权限控制，任何登录用户均可访问 `/admin/*`。后续需增加 `isAdmin` 权限校验。

| 页面 | 路由 | 功能 |
|------|------|------|
| 题库管理 | `/admin/problems` | 从洛谷同步 GESP 1-8 级官方题目，支持增量同步和全量重建 |
| 数据导入 | `/admin/import` | 通过浏览器脚本从洛谷批量获取题目 JSON，粘贴导入 |
| 提示词管理 | `/admin/prompts` | 15 个系统提示词在线编辑、对比默认值、一键重置 |

---

## 四、技术架构

### 4.1 技术栈

| 层级 | 技术选型 |
|------|---------|
| 前端框架 | Next.js 14（App Router）+ React 18 + TypeScript |
| UI 组件 | Tailwind CSS + shadcn/ui（Radix UI） |
| 代码编辑器 | Monaco Editor |
| 后端 | Next.js API Routes |
| 数据库 | PostgreSQL + Prisma ORM |
| 认证 | NextAuth.js（JWT + Credentials，30 天过期） |
| AI 引擎 | Claude Sonnet 4.5（Anthropic API） |
| 代码评测 | Judge0 API |
| 语音识别 | 讯飞实时语音听写 API |
| 3D 特效 | Three.js |
| 部署 | Railway |

### 4.2 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户浏览器                              │
│               GESP.AI（Next.js 前端）                      │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                  Railway 部署平台                          │
│         Next.js 应用（页面渲染 + API 路由 + 服务逻辑）       │
└──────┬─────────────────┬─────────────────┬──────────────┘
       │                 │                 │
       ▼                 ▼                 ▼
 ┌──────────┐     ┌──────────┐     ┌──────────┐
 │PostgreSQL│     │Claude API│     │Judge0 API│
 │ (数据库)  │     │ (AI对话)  │     │  (判题)   │
 └──────────┘     └──────────┘     └──────────┘
```

### 4.3 环境变量

| 变量 | 必需 | 说明 |
|------|------|------|
| DATABASE_URL | 是 | PostgreSQL 连接字符串 |
| NEXTAUTH_SECRET | 是 | NextAuth 密钥 |
| NEXTAUTH_URL | 是 | 应用 URL |
| ANTHROPIC_API_KEY | 是 | Claude API 密钥 |
| JUDGE0_API_URL | 是 | Judge0 API 端点 |
| JUDGE0_API_KEY | 是 | Judge0 API 密钥 |
| NEXT_PUBLIC_IFLYTEK_ENABLED | 否 | 讯飞语音识别开关 |
| NEXT_PUBLIC_IFLYTEK_APP_ID | 否 | 讯飞应用 ID |
| IFLYTEK_API_KEY | 否 | 讯飞 API Key |
| IFLYTEK_API_SECRET | 否 | 讯飞 API Secret |

---

## 五、数据模型

### 5.1 模型总览（13 个表）

| 模型 | 表名 | 说明 |
|------|------|------|
| User | users | 用户信息、学习目标、AI 配置、统计数据 |
| Problem | problems | 题目（来源、级别、难度、描述、测试用例） |
| Submission | submissions | 代码提交（评测结果、AI 调试记录） |
| KnowledgePoint | knowledge_points | 知识点树形结构 |
| LearningRecord | learning_records | 学习进度（私教/费曼/练习/掌握度） |
| StudyPlan | study_plans | AI 生成的学习计划 |
| DailyTask | daily_tasks | 每日任务 |
| ChatHistory | chat_histories | AI 对话历史 |
| Badge | badges | 成就徽章 |
| ErrorCase | error_cases | 错题记录（三问答案、AI 分析） |
| PreventionRule | prevention_rules | 防错规则（触发统计） |
| SystemPrompt | system_prompts | 系统提示词（15 个，管理员可编辑） |
| MockExamResult | mock_exam_results | 模拟考试记录 |

### 5.2 关键模型字段

详见 `prisma/schema.prisma`。核心字段说明：

**User**：targetLevel(1-8)、examDate、weeklySchedule、streakDays、totalXp、badges[]、aiTutorPrompt/aiProblemPrompt/aiDebugPrompt/aiFeynmanPrompt

**Problem**：source('gesp_official'|'luogu'|'custom')、sourceId、level(1-8)、knowledgePoints[]、samples(Json)、testCases(Json)、timeLimit、memoryLimit

**LearningRecord**：progress(0-100)、practiceCount、correctCount、masteryLevel(0-100)、tutorCompleted、feynmanCompleted、feynmanScore

**ErrorCase**：errorType(10种)、q1Answer/q2Answer/q3Answer、aiAnalysis、status(pending/in_progress/completed)

---

## 六、页面与 API

### 6.1 页面清单

| 页面 | 路由 | 状态 |
|------|------|------|
| 落地页 | `/` | ✅ |
| 登录 | `/login` | ✅ |
| 注册 | `/register` | ✅ |
| 首页仪表盘 | `/dashboard` | ✅ |
| 学习目标设置 | `/setup` | ✅ |
| 知识点地图 | `/map` | ✅ |
| 学习模式选择 | `/learn/[topic]` | ✅ |
| AI 私教·学习 | `/learn/[topic]/tutor` | ✅ |
| AI 私教·验证 | `/learn/[topic]/feynman` | ✅ |
| 题库浏览 | `/problem` | ✅ |
| 做题页面 | `/problem/[id]` | ✅ |
| 错题本 | `/error-book` | ✅ |
| 错题复盘 | `/error-book/[id]` | ✅ |
| 防错规则 | `/error-book/rules` | ✅ |
| 模拟考试 | `/mock-exam` | ✅ |
| 数据导入 | `/import` | ✅ |
| 个人中心 | `/profile` | ✅ |
| AI 配置 | `/profile/ai-config` | ✅ |
| 梯度训练 | `/ladder` | ✅ |
| 题库管理 | `/admin/problems` | ✅ |
| 数据导入管理 | `/admin/import` | ✅ |
| 提示词管理 | `/admin/prompts` | ✅ |

### 6.2 API 端点清单

#### 认证

| 方法 | 端点 | 功能 |
|------|------|------|
| POST | `/api/auth/register` | 用户注册 |
| * | `/api/auth/[...nextauth]` | NextAuth 认证 |

#### 学习计划

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/api/plan` | 获取当前计划和今日任务 |
| POST | `/api/plan` | AI 生成学习计划（注入做题表现数据） |

#### 题目与评测

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/api/problems` | 题目列表（支持级别/难度/关键词筛选、分页） |
| GET | `/api/problems/[id]` | 题目详情 |
| POST | `/api/judge` | 提交代码评测 |
| GET | `/api/judge` | 获取提交历史 |
| GET | `/api/judge/test` | Judge0 连通性测试 |

#### AI 对话

| 方法 | 端点 | 功能 |
|------|------|------|
| POST | `/api/chat` | 统一 AI 对话（learn/feynman/problem/general） |
| POST | `/api/ai/debug-help` | AI 调试助手（渐进式提示） |

#### 用户

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/api/user/stats` | 用户统计数据 |
| POST | `/api/user/xp` | 更新 XP 经验值 |
| GET/POST | `/api/user/ai-config` | AI 提示词配置 |
| POST | `/api/user/ai-config/reset` | 重置 AI 配置 |
| GET/POST | `/api/learning-records` | 学习记录 |
| GET | `/api/speech/auth` | 讯飞语音认证签名 |

#### 错题诊断

| 方法 | 端点 | 功能 |
|------|------|------|
| GET/POST | `/api/error-case` | 错题列表/创建 |
| GET/PATCH/DELETE | `/api/error-case/[id]` | 错题详情/更新/删除 |
| POST | `/api/error-case/[id]/analyze` | AI 分析错误类型 |
| POST | `/api/error-case/[id]/hint` | AI 三问引导提示 |
| GET/POST | `/api/prevention-rules` | 防错规则列表/创建 |
| GET/PATCH/DELETE | `/api/prevention-rules/[id]` | 规则详情/更新/删除 |
| POST | `/api/prevention-rules/check` | 检查代码是否触发规则 |

#### 模拟考试

| 方法 | 端点 | 功能 |
|------|------|------|
| GET/POST/DELETE | `/api/mock-exam` | 考试记录查询/保存/清空 |

#### 数据导入

| 方法 | 端点 | 功能 |
|------|------|------|
| POST | `/api/import/luogu` | 洛谷数据导入 |
| POST | `/api/import/code` | 代码分析导入 |

#### 种子数据

| 方法 | 端点 | 功能 |
|------|------|------|
| GET/POST | `/api/seed` | 批量同步全部 1-8 级题目 |
| GET/POST | `/api/seed/gesp{1-8}` | 各级别题目同步（upsert 模式） |
| POST | `/api/seed/reset` | 重置数据 |
| POST | `/api/seed/cleanup` | 清理数据 |

#### 管理后台

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/api/admin/sync` | 检查题库同步状态 |
| POST | `/api/admin/sync/problem` | 同步单个题目 |
| POST | `/api/admin/import` | 批量导入题目 |
| GET | `/api/admin/prompts` | 获取全部提示词 |
| PUT | `/api/admin/prompts/[key]` | 更新/恢复提示词 |
| POST | `/api/admin/prompts/seed` | 初始化提示词到数据库 |

---

## 七、用户流程

```
首次使用：
注册 → 学习目标设置（/setup）→ 数据导入（可选）→ 首页仪表盘

日常使用：
登录 → 首页（今日任务）→ 点击任务 → 学习/做题 → 返回首页

学习流程：
知识点地图 → 选择知识点 → AI 私教学习 → 费曼验证 → 完成

做题流程：
选题 → 阅读题面 → 写代码 → 提交前自检 → Judge0 评测
  → AC → 获得 XP
  → 失败 → AI 调试助手 → 修改重交
  → 记录错题 → 三问复盘 → 生成防错规则
```

---

## 八、后续版本规划

### V2.1（近期）

| 功能 | 描述 |
|------|------|
| 管理员权限 | User 模型增加 isAdmin 字段，管理路由权限校验 |
| 模拟考试执行 | 完善计时、答题、自动交卷流程 |
| 对话式信息采集 | AI 对话自动采集学生学习背景 |
| 错题重做 | 从错题本重新做题，验证掌握 |

### V2.2（中期）

| 功能 | 描述 |
|------|------|
| 浏览器插件 | 自动同步洛谷做题数据 |
| 截图识别 | 上传截图识别题目和代码 |
| AI 出题 | AI 根据薄弱点生成变体练习题 |
| 家长端 | 查看孩子学习进度报告 |

### V3.0（长期）

| 功能 | 描述 |
|------|------|
| 排行榜 | 同级别学生每周竞争 |
| 社区 | 用户讨论、题解分享 |
| 视频讲解 | 算法动画可视化 |
| 平台合作 | 与洛谷等平台官方 API 对接 |

---

## 九、验收清单

- [x] 用户注册、登录、JWT 会话管理
- [x] 学习目标设置（级别、考试日期、每周时间）
- [x] AI 根据目标和做题表现生成个性化学习计划
- [x] 首页展示 AI 决定的每日任务
- [x] 知识点地图展示 1-8 级共 80 个知识点
- [x] AI 私教·学习模式（先教后引）
- [x] AI 私教·验证模式（费曼学习法 + 多维评估）
- [x] 题库 184 道 GESP 1-8 级官方真题
- [x] Monaco 编辑器 + Judge0 在线评测
- [x] AI 调试助手（渐进式三级提示）
- [x] 错题本：AI 错误分类（10 种）+ 三问复盘 + 防错规则
- [x] 提交前自动检查防错规则
- [x] 游戏化：XP + 连胜 + 7 种徽章
- [x] 语音输入（讯飞，中英文）
- [x] 用户自定义 4 种场景 AI 提示词
- [x] 模拟考试页面（通过率预估、历史记录）
- [x] 管理后台：题库同步 + 数据导入 + 15 个提示词管理
- [x] 部署到 GESP.AI 并可访问
- [ ] 管理后台权限控制
- [ ] 模拟考试执行流程
- [ ] 对话式信息采集功能
- [ ] 赵知行完成完整使用测试

---

*文档版本：v2.0*
*更新日期：2026年2月8日*
