# GESP AI 产品需求文档 (PRD)

**版本**：MVP v1.0  
**日期**：2026年1月28日  
**目标上线**：1周内（2026年2月4日前）  
**域名**：GESP.AI  
**部署平台**：Railway  

---

## 一、产品概述

### 1.1 产品定位

**GESP AI 是一个 AI原生 的 GESP 编程等级考试备考产品。**

核心区别于其他产品：
- **AI原生**：AI是决策中枢，不是执行工具
- **AI决定学什么** → 用户跟着执行（而非用户决定、AI辅助）

### 1.2 第一用户

| 维度 | 信息 |
|------|------|
| **姓名** | 赵知行 |
| **年级** | 小学5年级 |
| **当前水平** | 刚通过GESP C++ 4级（2025年12月） |
| **目标** | GESP C++ 5级 |
| **考试日期** | 2026年3月14日 |
| **备考时间** | 约45天 |
| **主要刷题平台** | 洛谷 |

### 1.3 成功标准

**赵知行在2026年3月14日通过GESP 5级考试 = MVP验证成功**

---

## 二、核心原则

### 2.1 AI原生：AI是决策中枢

| 功能 | ❌ AI增强的做法 | ✅ AI原生的做法（GESP AI） |
|-----|----------------|--------------------------|
| **学习规划** | 用户选课程，AI推荐相关内容 | **AI根据目标日期、当前水平，决定每天学什么** |
| **练习选题** | 用户找题，AI帮忙讲解 | **AI根据薄弱点，决定该练哪道题** |
| **问题诊断** | 用户问才回答 | **AI主动发现"你DFS边界条件有问题"** |
| **进度调整** | 用户自己决定加快/放慢 | **AI根据表现，决定调整计划** |

**检验标准**：用户每次打开GESP AI，首页直接显示**AI决定的今日任务**，而不是让用户自己选。

### 2.2 先教后引的教学方法论

AI在教学过程中必须遵循以下原则：

1. ✅ **先给出核心概念的简明解释**（不让孩子猜基础定义）
2. ✅ **用可视化/比喻帮助理解**（迷宫图、生活例子）
3. ✅ **在关键决策点提问**（"你觉得下一步怎么做？"）
4. ✅ **允许孩子说"我不知道"**，给提示而不是继续追问
5. ✅ **保持正向反馈**（"对！""很接近了！""太棒了！"）

### 2.3 亲切老师的对话风格

| 场景 | ❌ 传统方式 | ✅ GESP AI |
|-----|-----------|-----------|
| 解释DFS | "深度优先搜索是一种遍历或搜索树或图的算法" | "DFS就像走迷宫🌀，选一条路一直走到底，走不通就退回来换条路试试！" |
| 代码错误 | "编译错误：缺少分号" | "哎呀，这行代码忘记加句号(分号)了，就像写作文忘记打句号一样！加上试试？" |
| 学生卡住 | "请仔细阅读题目" | "别着急～我们一起来看看题目在说什么，先找出关键信息好不好？🔍" |
| AC通过 | "Accepted" | "太厉害啦！🎉 一次就AC了！你今天已经超过90%的小朋友了！" |

---

## 三、MVP功能清单

### 3.1 功能总览

| 模块 | 功能 | 优先级 | 状态 |
|------|------|--------|------|
| **用户系统** | 注册/登录（邮箱或用户名+密码） | P0 | MVP |
| **学习规划** | 输入目标+时间 → AI生成计划 | P0 | MVP |
| **今日任务** | 首页显示AI决定的今日任务 | P0 | MVP |
| **AI教学对话** | 先教后引的知识点讲解 | P0 | MVP |
| **代码编辑器** | 内嵌Monaco编辑器 | P0 | MVP |
| **OJ判题** | 代码提交、编译、运行、判题 | P0 | MVP |
| **题库模块** | 从洛谷+GESP官网自动搜集 | P0 | MVP |
| **数据导入** | 洛谷用户名抓取+代码粘贴+对话采集 | P0 | MVP |
| **知识点地图** | 5级知识点进度可视化 | P0 | MVP |
| **连胜系统** | 每日完成任务保持连胜 | P0 | MVP |
| **XP经验值** | AC得分，累计经验 | P0 | MVP |
| **简单徽章** | 首次AC、7天连胜等里程碑徽章 | P1 | MVP |
| **费曼验证** | AC后偶尔让用户讲解思路（简单版） | P1 | MVP |
| **AI调试助手** | 代码错误时渐进式智能提示 | P0 | MVP |

### 3.2 用户系统

**功能描述**：
- 用户可以通过邮箱或用户名+密码注册和登录
- 登录后数据持久化保存

**数据模型**：
```
User {
  id: string
  email: string (optional)
  username: string
  password: string (hashed)
  created_at: datetime
  
  // 学习目标
  target_level: number (5)
  exam_date: date (2026-03-14)
  weekly_schedule: json // 每周可用时间
  
  // 统计数据
  streak_days: number
  total_xp: number
  badges: string[]
}
```

### 3.3 学习规划

**用户输入**：
1. 目标级别：GESP 5级
2. 考试日期：2026年3月14日
3. 当前水平：刚过4级（或通过数据导入自动诊断）
4. 每周可用时间：如"周六2小时、周日2小时、周三晚1小时"

**AI输出**：
1. 按周分配的知识点学习计划
2. 每个知识点的预估学习时间
3. 整体预计完成时间和通过概率

**动态调整**：
- 如果某周未完成，自动顺延
- AI根据实际表现调整后续计划
- 临近考试时给出冲刺建议

**GESP 5级知识点范围**：
```
5级知识点
├── 初等数论
│   ├── GCD最大公约数（辗转相除法）
│   ├── LCM最小公倍数
│   └── 素数筛法（埃氏筛）
├── 数据结构
│   └── 链表基础
├── 算法
│   ├── 二分查找
│   ├── 分治算法
│   ├── 贪心算法
│   └── 递归深化
├── 搜索
│   ├── DFS深度优先搜索
│   └── BFS广度优先搜索
├── 动态规划
│   └── 一维DP入门
└── 高精度
    └── 高精度加减乘
```

### 3.4 今日任务（首页）

**页面元素**：
```
┌─────────────────────────────────────────────────────────────────┐
│  GESP AI                                    🔥12天连胜  ⭐850XP │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  👋 知行，今天继续加油！                                          │
│                                                                 │
│  📅 距离5级考试还有 32 天                                        │
│  📊 当前进度：45%  ████████░░░░░░░░░░░░                         │
│  🎯 预计通过率：72%                                              │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  📚 今日任务                                                     │
│                                                                 │
│  □ 1. 学习：DFS递归实现（预计15分钟）              [开始学习]    │
│  □ 2. 练习：洛谷P1605 迷宫（预计20分钟）           [开始做题]    │
│  □ 3. 复习：昨日错题回顾（预计10分钟）             [开始复习]    │
│                                                                 │
│  ✅ 完成今日任务：+50XP，连胜+1                                  │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  📈 知识点地图                                     [查看全部 >]  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ GCD/LCM ✅  素数筛 ✅  DFS ⏳  BFS ○  DP ○  高精度 ○   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**AI决策逻辑**：
1. 根据学习计划确定本周重点知识点
2. 根据用户设定的今日可用时间分配任务
3. 优先安排：新知识点学习 > 练习巩固 > 错题复习
4. 如果昨天有未完成任务，优先补上

### 3.5 AI教学对话

**触发场景**：
1. 用户点击"开始学习"某个知识点
2. 用户做题时点击"求助"
3. 用户代码出错时的讲解
4. AC后的费曼验证（偶尔触发）

**对话界面**：
- 左侧：对话区域
- 右侧：代码编辑器（做题时）

**先教后引示例**（学习DFS）：
```
AI：知行，今天我们来学习DFS——深度优先搜索！

    想象你在走一个迷宫🌀。你会怎么走？
    
    DFS的策略是：选一条路，一直走到底，走不通了再退回来换条路。
    
    就像这样：
    [显示迷宫动画]
    
    在代码里，我们用"递归"来实现这个"一直走，走不通就退回来"的过程。
    
    基本模板是这样的：
    ```cpp
    void dfs(int x, int y) {
        if (到达终点) return;
        if (不能走) return;
        
        标记当前位置已访问;
        
        dfs(x+1, y);  // 尝试往下走
        dfs(x-1, y);  // 尝试往上走
        dfs(x, y+1);  // 尝试往右走
        dfs(x, y-1);  // 尝试往左走
        
        取消标记（回溯）;
    }
    ```
    
    你觉得，为什么要"取消标记"呢？🤔

用户：呃...我不太确定

AI：没关系！我来给你一个提示：
    
    如果我们在找"所有可能的路径"，走过A点后，退回来走另一条路时，
    可能还需要再经过A点。
    
    如果不取消标记，A点就被"锁死"了，另一条路就走不通了。
    
    但如果只是找"有没有路能到终点"，其实可以不取消标记。
    
    现在来试试这道入门题吧！👇
    [显示题目：迷宫问题]
```

### 3.6 代码编辑器 + OJ判题

**编辑器要求**：
- 使用Monaco Editor（VSCode同款）
- 支持C++语法高亮
- 支持基本自动补全
- 支持代码格式化

**判题流程**：
```
用户提交代码
    ↓
发送到Judge0 API（或自建判题沙箱）
    ↓
编译代码
    ↓
运行测试用例（逐个）
    ↓
返回结果：AC / WA / TLE / CE / RE
    ↓
如果WA/CE/RE，AI分析错误原因并给出提示
```

**判题结果展示**：
```
┌─────────────────────────────────────────────────────────────────┐
│  提交结果                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ✅ 测试点1：通过（0.01s）                                       │
│  ✅ 测试点2：通过（0.01s）                                       │
│  ❌ 测试点3：答案错误                                            │
│     输入：5 3                                                   │
│     期望输出：2                                                  │
│     你的输出：3                                                  │
│  ○ 测试点4：未运行                                               │
│  ○ 测试点5：未运行                                               │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  🤖 AI分析：                                                     │
│  看起来你的代码在边界情况下出了问题。当输入是5和3时，             │
│  你觉得应该怎么处理呢？提示：想想5除以3的余数...                  │
│                                                                 │
│                                          [再试一次]  [求助AI]    │
└─────────────────────────────────────────────────────────────────┘
```

### 3.7 题库模块

**数据来源**：
1. GESP官网真题（gesp.ccf.org.cn）
2. 洛谷GESP标签题（luogu.com.cn）

**题目数据模型**：
```
Problem {
  id: string
  title: string
  source: 'gesp_official' | 'luogu'
  source_id: string  // 如 'P1605'
  source_url: string
  
  level: number  // GESP级别 1-8
  knowledge_points: string[]  // 关联知识点
  difficulty: 'easy' | 'medium' | 'hard'
  
  description: string  // 题目描述
  input_format: string
  output_format: string
  samples: [{input: string, output: string}]
  
  test_cases: [{input: string, output: string}]  // 评测用例
  time_limit: number  // ms
  memory_limit: number  // MB
}
```

**搜集规则**：
- 只从指定平台搜集，不编造题目
- 需要人工构造测试用例（洛谷测试用例不公开）
- 优先搜集GESP 5级相关题目

**MVP题目数量目标**：
- GESP 5级真题：2-3套（约6-9道编程题）
- 洛谷筛选题：20-30道（覆盖5级各知识点）

### 3.8 数据导入

**方式1：洛谷用户名抓取**
```
用户输入洛谷用户名
    ↓
抓取用户公开的提交记录页（luogu.com.cn/user/xxx#practice）
    ↓
解析：题目ID、提交时间、结果（AC/WA）、代码（如果公开）
    ↓
导入GESP AI，生成能力画像
```

**方式2：代码批量粘贴**
```
用户粘贴代码 + 告诉AI这是哪道题
    ↓
AI分析代码，识别知识点和潜在问题
    ↓
记录到用户学习历史
```

**方式3：对话式采集**
```
AI：知行，为了更好地帮你规划学习，我想了解一下你之前的学习情况。
    你最近在洛谷做过哪些题？有没有哪些题卡住了？

用户：我做了P1605迷宫，WA了好几次，后来看题解才过的

AI：明白了！P1605是DFS的经典题。你还记得当时卡在哪里吗？

用户：好像是边界条件没处理好

AI：好的，我记下了。DFS的边界条件确实是个常见坑点，
    我会在后面的学习计划里安排专项练习。
    还有其他题吗？
```

### 3.9 知识点地图

**展示形式**：列表形式展示进度（MVP不做复杂可视化）

```
┌─────────────────────────────────────────────────────────────────┐
│  GESP 5级 知识点地图                                总进度：45%  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📗 初等数论                                              80%   │
│  ├── ✅ GCD最大公约数        掌握度：95%   已练习：5题          │
│  ├── ✅ LCM最小公倍数        掌握度：90%   已练习：3题          │
│  └── ✅ 素数筛法             掌握度：85%   已练习：4题          │
│                                                                 │
│  📘 搜索算法                                              40%   │
│  ├── ⏳ DFS深度优先搜索      掌握度：60%   已练习：3题  [继续]  │
│  └── ○ BFS广度优先搜索       掌握度：0%    未开始       [开始]  │
│                                                                 │
│  📙 动态规划                                              0%    │
│  └── ○ 一维DP入门           掌握度：0%    未开始       [锁定]  │
│                                                                 │
│  📕 高精度                                                0%    │
│  └── ○ 高精度加减乘         掌握度：0%    未开始       [锁定]  │
│                                                                 │
│  图例：✅已掌握  ⏳学习中  ○未开始  🔒锁定                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.10 游戏化：连胜 + XP + 徽章

**连胜系统**：
- 每天完成至少1道题或1个知识点学习，连胜+1
- 连胜天数显示在首页顶部
- 断签后连胜归零，重新开始
- MVP不做补签卡功能

**XP经验值**：
- AC一道简单题：+10 XP
- AC一道中等题：+20 XP
- AC一道困难题：+50 XP
- 完成知识点学习：+30 XP
- 完成每日任务：+50 XP（额外奖励）
- 连续AC（不WA）：额外+10 XP

**简单徽章**（MVP只做这几个）：
| 徽章 | 获得条件 |
|------|---------|
| 🎯 初次AC | 第一次AC任意题目 |
| 🔥 7天连胜 | 连续学习7天 |
| 🔥 30天连胜 | 连续学习30天 |
| ⭐ 500XP | 累计获得500XP |
| ⭐ 1000XP | 累计获得1000XP |
| 📗 数论入门 | 完成初等数论模块 |
| 📘 搜索入门 | 完成DFS+BFS模块 |

### 3.11 费曼验证（简单版）

**触发时机**：
- 用户AC一道题后，约20%概率触发
- 优先在新知识点的第一道AC题后触发

**对话示例**：
```
AI：太棒了，AC了！🎉
    
    我有个小请求：你能用自己的话给我讲讲，这道题你是怎么想的吗？
    就当我是一个刚学编程的小朋友～

用户：就是用DFS，从起点开始，每次尝试四个方向，走过的标记一下

AI：嗯嗯，那为什么要"标记走过的"呢？

用户：不然会一直在同一个地方转圈

AI：完全正确！👏 你已经理解了DFS的核心思想。

    [记录：用户对DFS基本原理理解正确]
```

### 3.12 AI调试助手

**设计理念**：
当学生代码提交错误时，不是简单显示"Wrong Answer"，而是通过AI智能分析，给出渐进式的引导提示，帮助学生自己发现和修复问题。

**核心原则**：
- 引导而非直接给答案
- 保留学生的思考空间
- 培养独立调试能力

**触发条件**：
代码提交后判题结果为以下错误时：
- ❌ WA (Wrong Answer) - 答案错误
- ❌ RE (Runtime Error) - 运行时错误
- ❌ TLE (Time Limit Exceeded) - 超时
- ❌ MLE (Memory Limit Exceeded) - 内存超限
- ✅ CE (Compile Error) - 编译错误直接显示编译器信息，不用AI

**AI获取信息**：
```json
{
  "problem": {
    "title": "数组求和",
    "description": "完整题目描述...",
    "samples": [...],
    "constraints": "0 ≤ n ≤ 1000"
  },
  "studentCode": "用户提交的C++代码",
  "result": {
    "verdict": "WA",
    "passedTests": 2,
    "totalTests": 5,
    "failedTests": [
      {
        "testIndex": 3,
        "input": "0",
        "expectedOutput": "0",
        "actualOutput": "未定义行为"
      }
    ]
  },
  "conversationHistory": [...],  // 之前的对话
  "studentLevel": 5
}
```

**渐进式提示策略**：

```
┌──────────────────────────────────────────────────────────┐
│ 第1次点击"AI帮我看看"                                    │
├──────────────────────────────────────────────────────────┤
│ 提示级别：轻（引导思考）                                 │
│                                                          │
│ 示例：                                                   │
│ "我注意到你的代码在处理空输入（n=0）时有问题。          │
│  想想看，当n=0时，数组为空，和应该是多少？"             │
│                                                          │
│ 特点：                                                   │
│ - 用问题引导                                             │
│ - 指出问题场景但不指出具体代码位置                       │
│ - 让学生自己思考                                         │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│ 第2次点击（如果还是不会）                                │
├──────────────────────────────────────────────────────────┤
│ 提示级别：中（指出位置）                                 │
│                                                          │
│ 示例：                                                   │
│ "问题在第10-15行的循环部分。                            │
│  当n=0时，循环不会执行，                                 │
│  但你没有给变量sum设置初始值。                          │
│  检查一下sum在定义时的初始化。"                          │
│                                                          │
│ 特点：                                                   │
│ - 定位到具体代码行                                       │
│ - 说明为什么有问题                                       │
│ - 仍然不直接给出修改代码                                 │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│ 第3次点击（最详细提示）                                  │
├──────────────────────────────────────────────────────────┤
│ 提示级别：详细（接近答案但不给完整代码）                 │
│                                                          │
│ 示例：                                                   │
│ "在第10行声明sum时，需要初始化为0：                     │
│  int sum = 0;                                           │
│                                                          │
│  这样即使循环不执行（n=0），sum也有明确的值。           │
│  试试加上这个初始化再提交看看。"                         │
│                                                          │
│ 特点：                                                   │
│ - 给出具体修改建议                                       │
│ - 可能包含代码片段                                       │
│ - 但不给完整的正确代码                                   │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│ 第4次及以后（保持详细级别）                              │
├──────────────────────────────────────────────────────────┤
│ AI能看到学生的代码修改历史和对话历史                    │
│                                                          │
│ 示例：                                                   │
│ "你这次改进了初始化，做得好！                           │
│  但现在测试点4还是错误。                                 │
│  我看到你的循环边界是 i <= n，                          │
│  考虑一下数组下标是从0还是1开始的？"                     │
│                                                          │
│ 特点：                                                   │
│ - 持续对话，记住上下文                                   │
│ - 肯定进步，继续引导                                     │
│ - 可以深入讨论更细节的问题                               │
└──────────────────────────────────────────────────────────┘
```

**使用限制**：
- ✅ 不限制使用次数
- ✅ 记住完整对话历史
- ✅ 可以追踪学生的代码修改

**UI展示**：

```
┌─────────────────────────────────────────────────────────────────┐
│  [题目描述区]          │  [代码编辑器]                │ [AI助手] │
│                        │                              │         │
│  题目内容...           │  #include <iostream>         │  🤖     │
│                        │  ...                         │         │
│                        │                              │  AI     │
│                        │──────────────────────────    │  学习   │
│                        │ ❌ WA (2/5)                 │  助手   │
│                        │ 测试点3：答案错误            │         │
│                        │                              │  [关闭] │
│                        │ 输入：0                      │  ──────  │
│                        │ 预期：0                      │         │
│                        │ 你的：未定义                 │  第1次  │
│                        │                              │  ┌────┐ │
│                        │ [💡 AI帮我看看 (第1次)]    │  │AI: │ │
│                        │                              │  │我注│ │
│                        │                              │  │意到│ │
│                        │                              │  │... │ │
│                        │                              │  └────┘ │
│                        │                              │         │
│                        │                              │  [继续] │
│                        │                              │  [分析] │
└─────────────────────────────────────────────────────────────────┘
```

**AI助手侧边栏**（点击按钮后从右侧滑出）：
- 宽度：400px
- 位置：固定在右侧
- 可收起/展开
- 显示完整对话历史
- 每次分析后自动添加到历史记录

**语言风格**：
- ✅ 清晰直接
- ✅ 适当鼓励（"你改进了！""很接近了！"）
- ❌ 不打比喻
- ❌ 不刻意迎合小学生语气
- ❌ 不用"小朋友""宝贝"等称呼

**AI模型**：
- 使用 Claude Opus 4.5
- 确保分析质量和教学效果

**Prompt设计要点**：
```
你是一位编程老师，正在辅导小学5年级的学生备考GESP C++考试。

学生信息：
- 年级：小学5年级
- 目标：GESP C++ 5级考试
- 当前水平：刚通过4级

你的角色：
1. 永远不要直接给出完整的正确代码
2. 通过提问和提示引导学生自己思考
3. 使用清晰直接的语言，不要打比喻
4. 适当给予正向反馈和鼓励
5. 根据提示次数调整帮助程度：
   - 第1次：轻提示（引导思考）
   - 第2次：中等提示（指出位置和原因）
   - 第3次及以后：详细提示（给修改建议但不给完整代码）

当前情况：
[题目、代码、错误信息、对话历史...]

请给出适合当前提示级别的帮助（不超过150字）。
```

**对话历史存储**：
- 每次AI分析作为一条对话记录
- 关联到具体的提交记录
- 用户下次提交时，AI能看到之前的对话
- 记录提示次数，控制渐进策略

---

## 四、技术架构

### 4.1 技术栈

| 层级 | 技术选型 |
|------|---------|
| **前端** | Next.js + React + TypeScript |
| **UI组件** | Tailwind CSS + shadcn/ui |
| **代码编辑器** | Monaco Editor |
| **后端** | Next.js API Routes |
| **数据库** | Supabase (PostgreSQL) |
| **AI** | Claude API |
| **判题** | Judge0 API |
| **部署** | Railway |
| **域名** | GESP.AI |

### 4.2 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                           用户浏览器                             │
│                    (GESP.AI - Next.js前端)                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Railway (部署平台)                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Next.js 应用                           │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │  页面    │  │  API     │  │  服务    │              │   │
│  │  │  渲染    │  │  路由    │  │  逻辑    │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
          │                    │                    │
          ▼                    ▼                    ▼
   ┌────────────┐      ┌────────────┐      ┌────────────┐
   │  Supabase  │      │ Claude API │      │ Judge0 API │
   │  (数据库)   │      │  (AI对话)  │      │  (判题)    │
   └────────────┘      └────────────┘      └────────────┘
```

### 4.3 数据库表结构

```sql
-- 用户表
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  
  -- 学习目标
  target_level INTEGER DEFAULT 5,
  exam_date DATE,
  weekly_schedule JSONB,
  
  -- 统计
  streak_days INTEGER DEFAULT 0,
  last_active_date DATE,
  total_xp INTEGER DEFAULT 0,
  badges TEXT[] DEFAULT '{}'
);

-- 学习计划表
CREATE TABLE study_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  
  plan_data JSONB,  -- AI生成的完整计划
  current_week INTEGER DEFAULT 1,
  status VARCHAR(20) DEFAULT 'active'  -- active, completed, paused
);

-- 题目表
CREATE TABLE problems (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(255) NOT NULL,
  source VARCHAR(50) NOT NULL,  -- 'gesp_official', 'luogu'
  source_id VARCHAR(50),
  source_url TEXT,
  
  level INTEGER,
  knowledge_points TEXT[],
  difficulty VARCHAR(20),
  
  description TEXT,
  input_format TEXT,
  output_format TEXT,
  samples JSONB,
  test_cases JSONB,
  time_limit INTEGER DEFAULT 1000,
  memory_limit INTEGER DEFAULT 256
);

-- 提交记录表
CREATE TABLE submissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  problem_id UUID REFERENCES problems(id),
  created_at TIMESTAMP DEFAULT NOW(),

  code TEXT,
  language VARCHAR(20) DEFAULT 'cpp',
  status VARCHAR(20),  -- 'AC', 'WA', 'TLE', 'CE', 'RE'

  test_results JSONB,  -- 每个测试点的结果
  xp_earned INTEGER DEFAULT 0,

  -- AI调试助手相关
  ai_help_count INTEGER DEFAULT 0,  -- 该提交请求AI帮助的次数
  ai_conversations JSONB  -- AI调试对话历史 [{prompt_level: 1, ai_response: '...', timestamp: '...'}]
);

-- 学习记录表
CREATE TABLE learning_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  
  type VARCHAR(50),  -- 'knowledge_point', 'problem', 'review'
  knowledge_point VARCHAR(100),
  problem_id UUID REFERENCES problems(id),
  
  duration_minutes INTEGER,
  xp_earned INTEGER DEFAULT 0,
  notes TEXT
);

-- 对话历史表
CREATE TABLE chat_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  
  context VARCHAR(100),  -- 'learning', 'problem_help', 'feynman'
  problem_id UUID REFERENCES problems(id),
  
  messages JSONB  -- [{role: 'user'|'assistant', content: '...'}]
);
```

---

## 五、页面结构

### 5.1 页面清单

| 页面 | 路由 | 描述 |
|------|------|------|
| 登录/注册 | `/auth` | 用户认证 |
| 首页（今日任务） | `/` | AI决定的今日任务、进度概览 |
| 学习规划设置 | `/setup` | 首次使用时设置目标和时间 |
| 知识点学习 | `/learn/[topic]` | AI教学对话 |
| 做题页面 | `/problem/[id]` | 代码编辑器+AI辅助 |
| 知识点地图 | `/map` | 完整知识点进度 |
| 数据导入 | `/import` | 导入洛谷数据 |
| 个人中心 | `/profile` | 统计、徽章、设置 |

### 5.2 页面流程

```
首次使用：
注册 → 学习规划设置 → 数据导入（可选）→ 首页

日常使用：
登录 → 首页（看今日任务）→ 点击任务 → 学习/做题 → 返回首页

做题流程：
选择题目 → 阅读题目 → 写代码 → 提交 → 查看结果 → (求助AI) → AC → (费曼验证)
```

---

## 六、后续版本规划

### V1.1（MVP后2周）

| 功能 | 描述 |
|------|------|
| **浏览器插件** | 自动同步洛谷做题数据 |
| **截图识别** | 上传截图识别题目和代码 |
| **更多徽章** | DFS大师、Bug猎人等专项徽章 |
| **补签卡** | 用XP兑换补签，恢复连胜 |
| **错题本** | 自动收集错题，支持重做 |

### V1.2（MVP后1个月）

| 功能 | 描述 |
|------|------|
| **家长端** | 查看孩子学习进度报告 |
| **智能推送** | 在用户常用学习时间推送提醒 |
| **更多知识点可视化** | 技能树/地图形式展示 |
| **模拟考试** | 完整模拟GESP 5级考试 |

### V1.3（MVP后2个月）

| 功能 | 描述 |
|------|------|
| **排行榜/联赛** | 同级别学生每周竞争 |
| **好友系统** | 加好友、组队学习 |
| **小G吉祥物** | 动态表情、情感互动 |
| **更多级别支持** | 扩展到GESP 1-8级 |

### V2.0（长期）

| 功能 | 描述 |
|------|------|
| **API官方对接** | 与洛谷等平台官方合作 |
| **AI出题** | AI根据薄弱点生成变体题 |
| **视频讲解** | 算法动画可视化 |
| **社区** | 用户讨论、题解分享 |

---

## 七、验收标准

### MVP验收清单

- [ ] 用户可以注册、登录
- [ ] 用户可以设置学习目标（级别、考试日期、每周时间）
- [ ] AI可以根据目标生成学习计划
- [ ] 首页显示AI决定的今日任务
- [ ] 用户可以进行知识点学习（AI对话）
- [ ] 用户可以在内嵌编辑器中写代码
- [ ] 代码可以提交并得到判题结果
- [ ] 题库中有至少20道GESP 5级相关题目
- [ ] 用户可以通过洛谷用户名导入数据
- [ ] 用户可以通过粘贴代码导入数据
- [ ] 知识点地图显示学习进度
- [ ] 连胜系统正常工作
- [ ] XP经验值正常累计
- [ ] 可以获得基础徽章
- [ ] 部署到GESP.AI并可访问
- [ ] 赵知行可以正常使用并开始备考

---

*文档版本：v1.0*  
*创建日期：2026年1月28日*  
*目标用户：赵知行（小学5年级，GESP 4级→5级，2026年3月14日考试）*
