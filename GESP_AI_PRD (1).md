# GESP AI 产品需求文档 (PRD)

**版本**：MVP v1.1
**更新日期**：2026年1月30日
**原始日期**：2026年1月28日
**目标上线**：1周内（2026年2月4日前）
**域名**：GESP.AI
**部署平台**：Railway

---

## 一、产品概述

### 1.1 产品定位

**GESP AI 是一个 AI原生 的 GESP 编程等级考试备考产品。**

核心区别于其他产品：
- **AI原生**：AI是决策中枢，不是执行工具
- **AI决定学什么** → 用户跟着执行（而非用户决定、AI辅助）

### 1.2 第一用户

| 维度 | 信息 |
|------|------|
| **姓名** | 赵知行 |
| **年级** | 小学5年级 |
| **当前水平** | 刚通过GESP C++ 4级（2025年12月） |
| **目标** | GESP C++ 5级 |
| **考试日期** | 2026年3月14日 |
| **备考时间** | 约45天 |
| **主要刷题平台** | 洛谷 |

### 1.3 成功标准

**赵知行在2026年3月14日通过GESP 5级考试 = MVP验证成功**

---

## 二、核心原则

### 2.1 AI原生：AI是决策中枢

| 功能 | ❌ AI增强的做法 | ✅ AI原生的做法（GESP AI） |
|-----|----------------|--------------------------|
| **学习规划** | 用户选课程，AI推荐相关内容 | **AI根据目标日期、当前水平，决定每天学什么** |
| **练习选题** | 用户找题，AI帮忙讲解 | **AI根据薄弱点，决定该练哪道题** |
| **问题诊断** | 用户问才回答 | **AI主动发现"你DFS边界条件有问题"** |
| **进度调整** | 用户自己决定加快/放慢 | **AI根据表现，决定调整计划** |

**检验标准**：用户每次打开GESP AI，首页直接显示**AI决定的今日任务**，而不是让用户自己选。

### 2.2 先教后引的教学方法论

AI在教学过程中必须遵循以下原则：

1. ✅ **先给出核心概念的简明解释**（不让孩子猜基础定义）
2. ✅ **用可视化/比喻帮助理解**（迷宫图、生活例子）
3. ✅ **在关键决策点提问**（"你觉得下一步怎么做？"）
4. ✅ **允许孩子说"我不知道"**，给提示而不是继续追问
5. ✅ **保持正向反馈**（"对！""很接近了！""太棒了！"）

### 2.3 亲切老师的对话风格

| 场景 | ❌ 传统方式 | ✅ GESP AI |
|-----|-----------|-----------|
| 解释DFS | "深度优先搜索是一种遍历或搜索树或图的算法" | "DFS就像走迷宫🌀，选一条路一直走到底，走不通就退回来换条路试试！" |
| 代码错误 | "编译错误：缺少分号" | "哎呀，这行代码忘记加句号(分号)了，就像写作文忘记打句号一样！加上试试？" |
| 学生卡住 | "请仔细阅读题目" | "别着急～我们一起来看看题目在说什么，先找出关键信息好不好？🔍" |
| AC通过 | "Accepted" | "太厉害啦！🎉 一次就AC了！你今天已经超过90%的小朋友了！" |

---

## 三、MVP功能清单

### 3.1 功能总览

| 模块 | 功能 | 优先级 | 状态 |
|------|------|--------|------|
| **用户系统** | 注册/登录（邮箱或用户名+密码） | P0 | ✅ 已完成 |
| **学习规划** | 输入目标+时间 → AI生成计划 | P0 | ✅ 已完成 |
| **今日任务** | 首页显示AI决定的今日任务 | P0 | ✅ 已完成 |
| **AI私教** | 先教后引的知识点讲解 | P0 | ✅ 已完成 |
| **费曼学习** | 用户向AI讲解知识点，获取学习评估 | P0 | ✅ 已完成 |
| **代码编辑器** | 内嵌Monaco编辑器 | P0 | ✅ 已完成 |
| **OJ判题** | 代码提交、编译、运行、判题 | P0 | ✅ 已完成 |
| **题库模块** | 从洛谷+GESP官网自动搜集 | P0 | ✅ 已完成 |
| **数据导入** | 洛谷用户名抓取+代码粘贴+对话采集 | P0 | 🚧 框架完成 |
| **知识点地图** | 1-8级知识点完整展示 | P0 | ✅ 已完成 |
| **连胜系统** | 每日完成任务保持连胜 | P0 | ✅ 已完成 |
| **XP经验值** | AC得分，累计经验 | P0 | ✅ 已完成 |
| **简单徽章** | 首次AC、7天连胜等里程碑徽章 | P1 | ✅ 已完成 |
| **AI调试助手** | 代码错误时渐进式智能提示 | P0 | ✅ 已完成 |
| **AI配置中心** | 四种场景的提示词自定义 | P1 | ✅ 已完成 |
| **语音输入** | 支持中英文语音输入 | P2 | ✅ 已完成 |

### 3.2 用户系统

**功能描述**：
- 用户可以通过邮箱或用户名+密码注册和登录
- 登录后数据持久化保存
- JWT会话管理（30天过期）

**数据模型**：
```
User {
  id: string (UUID)
  email: string (optional, unique)
  username: string (unique)
  passwordHash: string
  createdAt: datetime
  updatedAt: datetime

  // 学习目标
  targetLevel: number (1-8, 默认5)
  examDate: date
  weeklySchedule: json // 每周可用时间

  // 统计数据
  streakDays: number
  lastActiveDate: date
  totalXp: number
  badges: string[]

  // AI配置 - 各场景的自定义提示词
  aiTutorPrompt: string   // AI私教提示词
  aiProblemPrompt: string // 题目辅导提示词
  aiDebugPrompt: string   // 调试助手提示词
  aiFeynmanPrompt: string // 费曼学习提示词
}
```

### 3.3 学习规划

**用户输入**：
1. 目标级别：GESP 1-8级
2. 考试日期：如2026年3月14日
3. 当前水平：刚过上一级（或通过数据导入自动诊断）
4. 每周可用时间：如"周六2小时、周日2小时、周三晚1小时"

**AI输出**：
1. 按周分配的知识点学习计划
2. 每个知识点的预估学习时间
3. 整体预计完成时间和通过概率

**动态调整**：
- 如果某周未完成，自动顺延
- AI根据实际表现调整后续计划
- 临近考试时给出冲刺建议

**GESP知识点范围**：

系统内置完整的GESP 1-8级知识点库，基于CCF官方考纲整理：

| 级别 | 主要内容 |
|------|---------|
| 1级 | C++程序框架、数据输入输出、基本数据类型、常量与变量 |
| 2级 | 算术/关系/逻辑运算符、分支与循环结构、一维数组、函数基础 |
| 3级 | 二维数组、字符与字符串、递归函数、排序基础 |
| 4级 | 结构体、链表基础、文件读写、STL入门 |
| 5级 | 初等数论、二分查找、DFS/BFS、一维DP、高精度 |
| 6级 | 二维DP、图论基础、高级数据结构 |
| 7级 | 高级图论算法、复杂DP |
| 8级 | 竞赛级算法与数据结构 |

### 3.4 今日任务（首页）

**页面元素**：
```
┌─────────────────────────────────────────────────────────────────┐
│  GESP AI                                    🔥12天连胜  ⭐850XP │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  👋 知行，今天继续加油！                                          │
│                                                                 │
│  📅 距离5级考试还有 32 天                                        │
│  📊 当前进度：45%  ████████░░░░░░░░░░░░                         │
│  🎯 预计通过率：72%                                              │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  📚 今日任务                                                     │
│                                                                 │
│  □ 1. 学习：DFS递归实现（预计15分钟）              [开始学习]    │
│  □ 2. 练习：洛谷P1605 迷宫（预计20分钟）           [开始做题]    │
│  □ 3. 复习：昨日错题回顾（预计10分钟）             [开始复习]    │
│                                                                 │
│  ✅ 完成今日任务：+50XP，连胜+1                                  │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  📈 知识点地图                                     [查看全部 >]  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ GCD/LCM ✅  素数筛 ✅  DFS ⏳  BFS ○  DP ○  高精度 ○   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**AI决策逻辑**：
1. 根据学习计划确定本周重点知识点
2. 根据用户设定的今日可用时间分配任务
3. 优先安排：新知识点学习 > 练习巩固 > 错题复习
4. 如果昨天有未完成任务，优先补上

### 3.5 知识点学习（双模式）

**路由结构**：
```
/learn/[topic]         → 学习模式选择页
/learn/[topic]/tutor   → AI私教模式
/learn/[topic]/feynman → 费曼学习模式
```

#### 3.5.1 AI私教模式

**触发场景**：
- 用户在学习模式选择页点击"AI私教"

**页面布局**：
```
┌────────────────────────────────────────────────────────────────┐
│  ← 返回  AI私教 - DFS深度优先搜索                              │
│          GESP 5级 · 搜索算法                                   │
├──────────────────────┬─────────────────────────────────────────┤
│  知识点介绍          │  AI 私教                                │
│  ───────────         │  ─────────                              │
│  [知识点描述]        │  AI：今天我们来学习DFS！               │
│                      │                                         │
│  学习要点            │  想象你在走一个迷宫🌀...               │
│  • 递归实现          │                                         │
│  • 回溯思想          │  [用户输入框]                          │
│  • 边界条件          │                                         │
│                      │  支持语音输入 🎤                        │
│  学习建议            │                                         │
│  • 先理解基本概念    │                                         │
│  • 多看代码示例      │                                         │
│  • 完成相关练习题    │                                         │
└──────────────────────┴─────────────────────────────────────────┘
```

**先教后引示例**（学习DFS）：
```
AI：知行，今天我们来学习DFS——深度优先搜索！

    想象你在走一个迷宫🌀。你会怎么走？

    DFS的策略是：选一条路，一直走到底，走不通了再退回来换条路。

    就像这样：
    [显示迷宫动画]

    在代码里，我们用"递归"来实现这个"一直走，走不通就退回来"的过程。

    基本模板是这样的：
    ```cpp
    void dfs(int x, int y) {
        if (到达终点) return;
        if (不能走) return;

        标记当前位置已访问;

        dfs(x+1, y);  // 尝试往下走
        dfs(x-1, y);  // 尝试往上走
        dfs(x, y+1);  // 尝试往右走
        dfs(x, y-1);  // 尝试往左走

        取消标记（回溯）;
    }
    ```

    你觉得，为什么要"取消标记"呢？🤔

用户：呃...我不太确定

AI：没关系！我来给你一个提示：

    如果我们在找"所有可能的路径"，走过A点后，退回来走另一条路时，
    可能还需要再经过A点。

    如果不取消标记，A点就被"锁死"了，另一条路就走不通了。

    但如果只是找"有没有路能到终点"，其实可以不取消标记。

    现在来试试这道入门题吧！👇
    [显示题目：迷宫问题]
```

#### 3.5.2 费曼学习模式

**设计理念**：
费曼学习法的核心是"如果你能把一个概念讲给别人听，并让对方理解，说明你真正掌握了它"。

**角色定位**：
- **用户**：作为老师，向AI讲解知识点
- **AI**：作为好奇的学生，提出追问，帮助用户发现理解盲点

**页面布局**：
```
┌────────────────────────────────────────────────────────────────┐
│  ← 返回  费曼学习 - DFS深度优先搜索                            │
│          GESP 5级 · 搜索算法                                   │
├──────────────────────┬─────────────────────────────────────────┤
│  费曼学习法          │  向 AI 讲解               [结束讲解]   │
│  ───────────         │  ─────────                              │
│  什么是费曼学习法？  │  AI：嗨！👋 我听说你学了DFS，          │
│  [说明文字]          │      感觉好厉害！你能给我讲讲吗？      │
│                      │                                         │
│  你需要做什么？      │  用户：DFS就是深度优先搜索...          │
│  1. 用自己的话解释   │                                         │
│  2. 用简单的语言     │  AI：为什么要"深度优先"呢？            │
│  3. 回答AI的追问     │      和广度优先有什么区别？            │
│  4. 结束后获取评估   │                                         │
│                      │  [用户输入框]                          │
│  这个知识点包含：    │                                         │
│  • 递归实现          │  支持语音输入 🎤                        │
│  • 回溯思想          │                                         │
│  • 边界条件          │                                         │
└──────────────────────┴─────────────────────────────────────────┘
```

**AI行为原则**：
```
你是一个正在学习编程的学生，对C++和算法有一些基础了解，但很多概念还不太清楚。

## 你的角色
- 你是一个好奇、爱追问的学生
- 你希望对方能用简单的语言给你讲明白
- 你会在不理解的地方追问"为什么"
- 你会问"如果...会怎样"来测试对方的理解深度

## 互动方式
1. **开场**：表示你听说对方学了某个知识点，请他给你讲讲
2. **倾听**：认真听对方的讲解
3. **追问**：在关键概念处追问，比如：
   - "为什么要这样做？"
   - "如果不这样做会怎样？"
   - "能举个例子吗？"
   - "这个和XX有什么区别？"
4. **引导**：如果对方卡住了，给一些引导性的问题帮助他继续
5. **确认**：当你觉得理解了，说"我好像懂了"并复述一下

## 注意事项
- 使用中文交流
- 语气要像真正的学生，不要太正式
- 适度使用emoji表达情绪
- 不要主动教对方，而是通过提问让对方思考
- 如果对方讲错了，不要直接纠正，而是通过追问让他发现问题
```

**学习评估**：

用户点击"结束讲解，获取评估"后，AI会根据对话内容给出详细评估：

```
📊 学习评估报告

## 完整度评估 ⭐⭐⭐⭐☆
你讲解了DFS的基本概念、递归实现方式，但对于回溯和剪枝优化提及较少。

## 准确度评估 ⭐⭐⭐⭐⭐
讲解内容准确，没有发现明显错误。特别是对"为什么要标记已访问节点"的解释很到位！

## 清晰度评估 ⭐⭐⭐⭐☆
整体表达清晰，迷宫的比喻很形象。建议在解释递归调用栈时可以更详细一些。

## 薄弱点分析
- 对DFS的时间复杂度分析不够深入
- 可以补充更多实际应用场景的例子

## 总结
做得很棒！👏 你对DFS的核心思想理解得很透彻。建议接下来：
1. 多练习几道DFS的变体题
2. 尝试对比BFS，加深理解
3. 研究一下剪枝优化技巧

继续加油！🚀
```

### 3.6 代码编辑器 + OJ判题

**编辑器要求**：
- 使用Monaco Editor（VSCode同款）
- 支持C++语法高亮
- 支持基本自动补全
- 支持代码格式化
- 代码自动保存和回显

**判题流程**：
```
用户提交代码
    ↓
发送到Judge0 API（或自建判题沙箱）
    ↓
编译代码
    ↓
运行测试用例（逐个）
    ↓
返回结果：AC / WA / TLE / CE / RE / MLE
    ↓
如果WA/RE/TLE/MLE，显示AI调试助手入口
```

**判题结果展示**：
```
┌─────────────────────────────────────────────────────────────────┐
│  提交结果                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ✅ 测试点1：通过（0.01s, 1024KB）                              │
│  ✅ 测试点2：通过（0.01s, 1024KB）                              │
│  ❌ 测试点3：答案错误                                            │
│     输入：5 3                                                   │
│     期望输出：2                                                  │
│     你的输出：3                                                  │
│  ○ 测试点4：未运行                                               │
│  ○ 测试点5：未运行                                               │
│                                                                 │
│                                          [再试一次]  [AI帮我看看] │
└─────────────────────────────────────────────────────────────────┘
```

### 3.7 题库模块

**数据来源**：
1. GESP官网真题（gesp.ccf.org.cn）
2. 洛谷GESP标签题（luogu.com.cn）

**题目数据模型**：
```
Problem {
  id: string (UUID)
  title: string
  source: 'gesp_official' | 'luogu' | 'custom'
  sourceId: string  // 如 'P1605'
  sourceUrl: string

  level: number  // GESP级别 1-8
  knowledgePoints: string[]  // 关联知识点
  difficulty: string  // 洛谷难度

  description: string  // 题目描述（支持Markdown）
  inputFormat: string
  outputFormat: string
  samples: [{input: string, output: string, explanation?: string}]

  testCases: [{input: string, output: string}]  // 评测用例
  timeLimit: number  // ms（默认1000）
  memoryLimit: number  // MB（默认256）

  hint: string  // 提示
  solution: string  // 题解
}
```

**搜集规则**：
- 只从指定平台搜集，不编造题目
- 需要人工构造测试用例（洛谷测试用例不公开）
- 支持按级别和知识点筛选

**MVP题目数量目标**：
- GESP 1-8级真题：每级2-3套
- 洛谷筛选题：每级20-30道（覆盖各知识点）

### 3.8 数据导入

**方式1：洛谷用户名抓取**
```
用户输入洛谷用户名或个人主页URL
    ↓
抓取用户公开的提交记录页
    ↓
解析：题目ID、提交时间、结果（AC/WA）、代码（如果公开）
    ↓
导入GESP AI，生成能力画像
```

**方式2：代码批量粘贴**
```
用户粘贴代码 + 告诉AI这是哪道题
    ↓
AI分析代码，识别知识点和潜在问题
    ↓
记录到用户学习历史
```

**方式3：对话式采集**
```
AI：知行，为了更好地帮你规划学习，我想了解一下你之前的学习情况。
    你最近在洛谷做过哪些题？有没有哪些题卡住了？

用户：我做了P1605迷宫，WA了好几次，后来看题解才过的

AI：明白了！P1605是DFS的经典题。你还记得当时卡在哪里吗？

用户：好像是边界条件没处理好

AI：好的，我记下了。DFS的边界条件确实是个常见坑点，
    我会在后面的学习计划里安排专项练习。
    还有其他题吗？
```

**当前状态**：API框架已完成，数据解析逻辑开发中

### 3.9 知识点地图

**路由**：`/map`

**展示形式**：按级别标签页展示，列表形式展示各分类知识点

```
┌─────────────────────────────────────────────────────────────────┐
│  知识点                                                          │
├─────────────────────────────────────────────────────────────────┤
│  [1级] [2级] [3级] [4级] [5级✓] [6级] [7级] [8级]               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GESP C++ 5级                                                   │
│  考试时间：90分钟 | 选择题15题 + 编程题2题                       │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  📗 初等数论                                                    │
│  ├── GCD最大公约数        [开始学习]                            │
│  │   辗转相除法求最大公约数                                     │
│  ├── LCM最小公倍数        [开始学习]                            │
│  │   利用GCD计算最小公倍数                                      │
│  └── 素数筛法             [开始学习]                            │
│      埃拉托斯特尼筛法                                           │
│                                                                 │
│  📘 搜索算法                                                    │
│  ├── DFS深度优先搜索      [开始学习]                            │
│  │   递归实现、回溯思想                                         │
│  └── BFS广度优先搜索      [开始学习]                            │
│      队列实现、层次遍历                                         │
│                                                                 │
│  📙 动态规划                                                    │
│  └── 一维DP入门           [开始学习]                            │
│      状态定义与转移方程                                         │
│                                                                 │
│  📕 高精度                                                      │
│  └── 高精度加减乘         [开始学习]                            │
│      大整数运算实现                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**知识点数据结构**：
```typescript
interface KnowledgePoint {
  id: string;           // 唯一标识
  name: string;         // 知识点名称
  level: number;        // GESP级别 1-8
  category: string;     // 分类（基础语法/数据结构/算法/数学）
  description: string;  // 简短描述
  details: string[];    // 学习要点列表
}
```

### 3.10 游戏化：连胜 + XP + 徽章

**连胜系统**：
- 每天完成至少1道题或1个知识点学习，连胜+1
- 连胜天数显示在首页顶部
- 超过1天未活跃，连胜归零，重新开始
- MVP不做补签卡功能

**XP经验值**：
- AC一道简单题：+10 XP
- AC一道中等题：+20 XP
- AC一道困难题：+30 XP
- 完成知识点学习：+30 XP
- 完成每日任务：+50 XP（额外奖励）
- 连续AC（不WA）：额外+10 XP

**简单徽章**（MVP实现的7个）：
| 徽章 | 获得条件 |
|------|---------|
| 🎯 初次AC | 第一次AC任意题目 |
| 🔥 7天连胜 | 连续学习7天 |
| 🔥 30天连胜 | 连续学习30天 |
| ⭐ 500XP | 累计获得500XP |
| ⭐ 1000XP | 累计获得1000XP |
| 📗 数论入门 | 完成初等数论模块 |
| 📘 搜索入门 | 完成DFS+BFS模块 |

### 3.11 AI调试助手

**设计理念**：
当学生代码提交错误时，不是简单显示"Wrong Answer"，而是通过AI智能分析，给出渐进式的引导提示，帮助学生自己发现和修复问题。

**核心原则**：
- 引导而非直接给答案
- 保留学生的思考空间
- 培养独立调试能力

**触发条件**：
代码提交后判题结果为以下错误时：
- ❌ WA (Wrong Answer) - 答案错误
- ❌ RE (Runtime Error) - 运行时错误
- ❌ TLE (Time Limit Exceeded) - 超时
- ❌ MLE (Memory Limit Exceeded) - 内存超限
- ✅ CE (Compile Error) - 编译错误直接显示编译器信息，不用AI

**渐进式提示策略**：

```
┌──────────────────────────────────────────────────────────┐
│ 第1次点击"AI帮我看看"                                    │
├──────────────────────────────────────────────────────────┤
│ 提示级别：轻（引导思考）                                 │
│                                                          │
│ 示例：                                                   │
│ "我注意到你的代码在处理空输入（n=0）时有问题。          │
│  想想看，当n=0时，数组为空，和应该是多少？"             │
│                                                          │
│ 特点：                                                   │
│ - 用问题引导                                             │
│ - 指出问题场景但不指出具体代码位置                       │
│ - 让学生自己思考                                         │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│ 第2次点击（如果还是不会）                                │
├──────────────────────────────────────────────────────────┤
│ 提示级别：中（指出位置）                                 │
│                                                          │
│ 示例：                                                   │
│ "问题在第10-15行的循环部分。                            │
│  当n=0时，循环不会执行，                                 │
│  但你没有给变量sum设置初始值。                          │
│  检查一下sum在定义时的初始化。"                          │
│                                                          │
│ 特点：                                                   │
│ - 定位到具体代码行                                       │
│ - 说明为什么有问题                                       │
│ - 仍然不直接给出修改代码                                 │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│ 第3次点击（最详细提示）                                  │
├──────────────────────────────────────────────────────────┤
│ 提示级别：详细（接近答案但不给完整代码）                 │
│                                                          │
│ 示例：                                                   │
│ "在第10行声明sum时，需要初始化为0：                     │
│  int sum = 0;                                           │
│                                                          │
│  这样即使循环不执行（n=0），sum也有明确的值。           │
│  试试加上这个初始化再提交看看。"                         │
│                                                          │
│ 特点：                                                   │
│ - 给出具体修改建议                                       │
│ - 可能包含代码片段                                       │
│ - 但不给完整的正确代码                                   │
└──────────────────────────────────────────────────────────┘
```

**使用限制**：
- ✅ 不限制使用次数
- ✅ 记住完整对话历史
- ✅ 可以追踪学生的代码修改

**AI调试抽屉组件**：
- 从右侧滑出的抽屉式界面
- 显示完整对话历史
- 按提示级别分类
- 时间戳记录
- 继续分析按钮

**数据持久化**：
```typescript
// Submission 表字段
{
  aiHelpCount: number,        // 该提交请求AI帮助的次数
  aiConversations: [          // AI调试对话历史
    {
      promptLevel: number,    // 提示级别 1/2/3
      aiResponse: string,     // AI回复内容
      timestamp: string       // 时间戳
    }
  ]
}
```

### 3.12 AI提示词配置中心

**路由**：`/profile/ai-config`

**设计理念**：
用户可以自定义不同场景下AI的角色设定和行为方式，满足个性化需求。

**支持的四种场景**：

| 场景 | 标识 | 说明 |
|------|------|------|
| **AI私教** | tutor | 知识点学习时，AI作为老师的角色设定 |
| **题目辅导** | problem | 做题时，AI作为教练引导解题的角色设定 |
| **调试助手** | debug | 代码调试时，AI帮助分析错误的角色设定 |
| **费曼学习** | feynman | 费曼学习法中，AI作为提问学生的角色设定 |

**配置界面**：
```
┌─────────────────────────────────────────────────────────┐
│ 🤖 提示词配置                                           │
│ 自定义不同场景下 AI 的角色设定和行为方式                │
├─────────────────────────────────────────────────────────┤
│ [AI私教] [题目辅导] [调试助手] [费曼学习]              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 针对知识点学习时，AI 作为老师的角色设定                │
│                                                         │
│ 当前使用：自定义配置                    ● 有未保存的更改 │
│                                                         │
│ 系统提示词                                              │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 你是GESP AI，一位亲切友好的编程老师...             │ │
│ │                                                     │ │
│ │ ## 你的教学风格                                    │ │
│ │ - 语气亲切、鼓励性强                              │ │
│ │ - 使用生动的比喻和生活化的例子...                  │ │
│ │                                                     │ │
│ └─────────────────────────────────────────────────────┘ │
│ 字数：1,234 / 10,000                                    │
│                                                         │
│ [💾 保存配置]  [🔄 恢复默认]                           │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ 💡 提示词说明                                           │
│ • 提示词决定了 AI 的角色、教学风格和交互方式           │
│ • 修改后立即生效，下次使用相应功能时采用新配置         │
│ • 建议包含：角色定位、行为原则、回复要求               │
│ • 可以随时恢复为系统默认配置                           │
└─────────────────────────────────────────────────────────┘
```

**API接口**：
```
GET  /api/user/ai-config        # 获取用户所有AI配置
POST /api/user/ai-config        # 保存指定类型的提示词
POST /api/user/ai-config/reset  # 恢复指定类型的默认配置
```

**数据存储**：
```sql
-- users 表中的AI配置字段
aiTutorPrompt TEXT,   -- AI私教提示词（为空则使用默认）
aiProblemPrompt TEXT, -- 题目辅导提示词
aiDebugPrompt TEXT,   -- 调试助手提示词
aiFeynmanPrompt TEXT  -- 费曼学习提示词
```

### 3.13 语音输入功能

**设计理念**：
为小学生用户提供更便捷的输入方式，降低打字负担。

**功能特性**：
- 支持中英文双语识别（Web Speech API）
- 一键切换语言按钮
- 实时语音转文字
- 音量可视化指示器（3个跳动的点）
- 快捷键支持：空格键按住录音，松开停止
- 中文自动标点（基于停顿和语气词）

**界面元素**：
```
┌─────────────────────────────────────────────────────────────┐
│  [输入框]              [中/EN] [🎤] [发送]                   │
│                                                             │
│  ● ● ●  正在录音，点击麦克风或松开空格键停止...            │
└─────────────────────────────────────────────────────────────┘
```

**实现细节**：
- 使用 `useSpeechRecognition` 自定义 Hook
- 支持连续识别模式
- 语言偏好保存到 localStorage
- 错误提示3秒后自动消失

---

## 四、技术架构

### 4.1 技术栈

| 层级 | 技术选型 |
|------|---------|
| **前端** | Next.js 14 + React 18 + TypeScript |
| **UI组件** | Tailwind CSS + shadcn/ui + Radix UI |
| **代码编辑器** | Monaco Editor |
| **后端** | Next.js API Routes |
| **数据库** | PostgreSQL + Prisma ORM |
| **认证** | NextAuth.js (JWT策略) |
| **AI** | Claude API (Anthropic) |
| **判题** | Judge0 API |
| **部署** | Railway |
| **域名** | GESP.AI |

### 4.2 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                           用户浏览器                             │
│                    (GESP.AI - Next.js前端)                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Railway (部署平台)                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Next.js 应用                           │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │  页面    │  │  API     │  │  服务    │              │   │
│  │  │  渲染    │  │  路由    │  │  逻辑    │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
          │                    │                    │
          ▼                    ▼                    ▼
   ┌────────────┐      ┌────────────┐      ┌────────────┐
   │ PostgreSQL │      │ Claude API │      │ Judge0 API │
   │  (数据库)   │      │  (AI对话)  │      │  (判题)    │
   └────────────┘      └────────────┘      └────────────┘
```

### 4.3 数据库表结构

```sql
-- 用户表
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- 学习目标
  target_level INTEGER DEFAULT 5,
  exam_date DATE,
  weekly_schedule JSONB,

  -- 统计
  streak_days INTEGER DEFAULT 0,
  last_active_date DATE,
  total_xp INTEGER DEFAULT 0,
  badges TEXT[] DEFAULT '{}',

  -- AI配置 - 各场景的自定义提示词
  ai_tutor_prompt TEXT,
  ai_problem_prompt TEXT,
  ai_debug_prompt TEXT,
  ai_feynman_prompt TEXT
);

-- 学习计划表
CREATE TABLE study_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  start_date DATE,
  end_date DATE,
  target_level INTEGER,
  weekly_plan JSONB,  -- AI生成的完整计划
  is_active BOOLEAN DEFAULT TRUE
);

-- 每日任务表
CREATE TABLE daily_tasks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  date DATE,

  tasks JSONB,  -- [{type, targetId, title, completed, xpReward}]
  total_xp INTEGER DEFAULT 0,
  completed_xp INTEGER DEFAULT 0,
  is_completed BOOLEAN DEFAULT FALSE,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(user_id, date)
);

-- 题目表
CREATE TABLE problems (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(255) NOT NULL,
  source VARCHAR(50) NOT NULL,
  source_id VARCHAR(50),
  source_url TEXT,

  level INTEGER,
  knowledge_points TEXT[],
  difficulty VARCHAR(50),

  description TEXT,
  input_format TEXT,
  output_format TEXT,
  samples JSONB,
  test_cases JSONB,
  time_limit INTEGER DEFAULT 1000,
  memory_limit INTEGER DEFAULT 256,

  hint TEXT,
  solution TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 提交记录表
CREATE TABLE submissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  problem_id UUID REFERENCES problems(id),
  created_at TIMESTAMP DEFAULT NOW(),

  code TEXT,
  language VARCHAR(20) DEFAULT 'cpp',
  status VARCHAR(20),
  score INTEGER DEFAULT 0,

  compile_output TEXT,
  run_output TEXT,
  error_message TEXT,
  time_used INTEGER,
  memory_used INTEGER,

  test_results JSONB,

  -- AI调试助手相关
  ai_help_count INTEGER DEFAULT 0,
  ai_conversations JSONB
);

-- 知识点表
CREATE TABLE knowledge_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  level INTEGER,
  category VARCHAR(100),
  description TEXT,

  parent_id UUID REFERENCES knowledge_points(id),
  prerequisites TEXT[] DEFAULT '{}',

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 学习记录表
CREATE TABLE learning_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  knowledge_point_id UUID REFERENCES knowledge_points(id),

  status VARCHAR(20) DEFAULT 'not_started',
  progress INTEGER DEFAULT 0,

  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  last_studied_at TIMESTAMP,

  study_time INTEGER DEFAULT 0,
  practice_count INTEGER DEFAULT 0,
  correct_count INTEGER DEFAULT 0,

  UNIQUE(user_id, knowledge_point_id)
);

-- 对话历史表
CREATE TABLE chat_histories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  context VARCHAR(100),  -- 'learn_xxx' | 'feynman_xxx' | 'problem_xxx' | 'general'
  messages JSONB
);

-- 徽章表
CREATE TABLE badges (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  code VARCHAR(50) UNIQUE,
  name VARCHAR(100),
  description TEXT,
  icon VARCHAR(50),
  condition JSONB,

  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 五、页面结构

### 5.1 页面清单

| 页面 | 路由 | 描述 | 状态 |
|------|------|------|------|
| 登录 | `/login` | 用户登录 | ✅ |
| 注册 | `/register` | 用户注册 | ✅ |
| 首页（今日任务） | `/` | AI决定的今日任务、进度概览 | ✅ |
| 学习规划设置 | `/setup` | 首次使用时设置目标和时间 | ✅ |
| 学习模式选择 | `/learn/[topic]` | 选择AI私教或费曼学习 | ✅ |
| AI私教 | `/learn/[topic]/tutor` | AI教学对话 | ✅ |
| 费曼学习 | `/learn/[topic]/feynman` | 用户讲解，AI评估 | ✅ |
| 题目列表 | `/problem` | 题库浏览和筛选 | ✅ |
| 做题页面 | `/problem/[id]` | 代码编辑器+判题+AI辅助 | ✅ |
| 知识点地图 | `/map` | 1-8级完整知识点展示 | ✅ |
| 数据导入 | `/import` | 导入洛谷数据 | 🚧 |
| 个人中心 | `/profile` | 统计、徽章、设置 | ✅ |
| AI配置 | `/profile/ai-config` | 四种场景提示词配置 | ✅ |

### 5.2 页面流程

```
首次使用：
注册 → 学习规划设置 → 数据导入（可选）→ 首页

日常使用：
登录 → 首页（看今日任务）→ 点击任务 → 学习/做题 → 返回首页

学习流程：
知识点 → 选择学习模式（AI私教/费曼学习）→ 学习 → 完成

做题流程：
选择题目 → 阅读题目 → 写代码 → 提交 → 查看结果 → (AI调试) → AC
```

---

## 六、API端点清单

### 6.1 认证相关
| 方法 | 端点 | 功能 |
|------|------|------|
| POST | `/api/auth/register` | 用户注册 |
| POST | `/api/auth/[...nextauth]` | NextAuth认证处理 |

### 6.2 学习计划
| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/api/plan` | 获取当前计划和今日任务 |
| POST | `/api/plan` | 生成AI学习计划 |

### 6.3 题目与判题
| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/api/problems` | 题目列表（支持筛选、分页） |
| POST | `/api/problems` | 创建题目 |
| GET | `/api/problems/[id]` | 题目详情 |
| POST | `/api/judge` | 提交代码判题 |
| GET | `/api/judge` | 获取提交历史 |

### 6.4 AI对话
| 方法 | 端点 | 功能 |
|------|------|------|
| POST | `/api/chat` | 统一AI对话（learn/feynman/problem/general） |
| POST | `/api/ai/debug-help` | AI调试助手 |

### 6.5 用户相关
| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/api/user/stats` | 获取用户统计数据 |
| GET | `/api/user/ai-config` | 获取AI配置 |
| POST | `/api/user/ai-config` | 保存AI提示词 |
| POST | `/api/user/ai-config/reset` | 重置AI配置 |

### 6.6 数据导入
| 方法 | 端点 | 功能 |
|------|------|------|
| POST | `/api/import/luogu` | 洛谷数据导入 |
| POST | `/api/import/code` | 代码分析导入 |

### 6.7 数据初始化
| 方法 | 端点 | 功能 |
|------|------|------|
| POST | `/api/seed` | 统一初始化 |
| POST | `/api/seed/gesp[1-8]` | 各级别题目初始化 |
| POST | `/api/seed/reset` | 重置数据 |

---

## 七、后续版本规划

### V1.1（MVP后2周）

| 功能 | 描述 |
|------|------|
| **浏览器插件** | 自动同步洛谷做题数据 |
| **截图识别** | 上传截图识别题目和代码 |
| **更多徽章** | DFS大师、Bug猎人等专项徽章 |
| **补签卡** | 用XP兑换补签，恢复连胜 |
| **错题本** | 自动收集错题，支持重做 |

### V1.2（MVP后1个月）

| 功能 | 描述 |
|------|------|
| **家长端** | 查看孩子学习进度报告 |
| **智能推送** | 在用户常用学习时间推送提醒 |
| **更多知识点可视化** | 技能树/地图形式展示 |
| **模拟考试** | 完整模拟GESP考试 |

### V1.3（MVP后2个月）

| 功能 | 描述 |
|------|------|
| **排行榜/联赛** | 同级别学生每周竞争 |
| **好友系统** | 加好友、组队学习 |
| **小G吉祥物** | 动态表情、情感互动 |

### V2.0（长期）

| 功能 | 描述 |
|------|------|
| **API官方对接** | 与洛谷等平台官方合作 |
| **AI出题** | AI根据薄弱点生成变体题 |
| **视频讲解** | 算法动画可视化 |
| **社区** | 用户讨论、题解分享 |

---

## 八、验收标准

### MVP验收清单

- [x] 用户可以注册、登录
- [x] 用户可以设置学习目标（级别、考试日期、每周时间）
- [x] AI可以根据目标生成学习计划
- [x] 首页显示AI决定的今日任务
- [x] 用户可以选择AI私教或费曼学习模式
- [x] 用户可以进行知识点学习（AI对话）
- [x] 用户可以通过费曼学习获取评估
- [x] 用户可以在内嵌编辑器中写代码
- [x] 代码可以提交并得到判题结果
- [x] AI调试助手提供渐进式帮助
- [x] 题库中有GESP相关题目
- [x] 知识点地图显示1-8级完整知识点
- [x] 连胜系统正常工作
- [x] XP经验值正常累计
- [x] 可以获得基础徽章
- [x] 用户可以自定义四种场景的AI提示词
- [x] 支持语音输入（中英文）
- [x] 部署到GESP.AI并可访问
- [ ] 洛谷数据导入功能完善
- [ ] 赵知行完成完整的使用测试

---

*文档版本：v1.1*
*更新日期：2026年1月30日*
*目标用户：赵知行（小学5年级，GESP 4级→5级，2026年3月14日考试）*
