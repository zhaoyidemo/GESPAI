generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String?   @unique
  username      String    @unique
  passwordHash  String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 学习目标
  targetLevel   Int       @default(5)
  examDate      DateTime?
  weeklySchedule Json?

  // 统计数据
  streakDays    Int       @default(0)
  lastActiveDate DateTime?
  totalXp       Int       @default(0)
  badges        String[]  @default([])

  // AI配置 - 各场景的自定义提示词
  aiTutorPrompt  String?  @db.Text  // AI私教提示词
  aiProblemPrompt String? @db.Text  // 题目辅导提示词
  aiDebugPrompt  String?  @db.Text  // 调试助手提示词
  aiFeynmanPrompt String? @db.Text  // 费曼学习提示词

  // 关联关系
  studyPlans      StudyPlan[]
  submissions     Submission[]
  learningRecords LearningRecord[]
  chatHistories   ChatHistory[]
  dailyTasks      DailyTask[]
  errorCases      ErrorCase[]
  preventionRules PreventionRule[]

  @@map("users")
}

model Problem {
  id            String   @id @default(uuid())
  title         String
  source        String   // 'gesp_official' | 'luogu' | 'custom'
  sourceId      String?
  sourceUrl     String?

  level         Int      // GESP级别 1-8
  knowledgePoints String[]
  difficulty    String   // 洛谷难度：'入门' | '普及-' | '普及/提高-' | '普及+/提高' | '提高+/省选-' | '省选/NOI-' | 'NOI/NOI+/CTSC'

  background    String?  @db.Text  // 题目背景
  description   String   @db.Text
  inputFormat   String?  @db.Text
  outputFormat  String?  @db.Text
  samples       Json     // [{input: string, output: string, explanation?: string}]
  testCases     Json     // [{input: string, output: string}]
  timeLimit     Int      @default(1000)  // 毫秒
  memoryLimit   Int      @default(256)   // MB

  hint          String?  @db.Text
  solution      String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  submissions   Submission[]
  errorCases    ErrorCase[]

  @@map("problems")
}

model Submission {
  id            String   @id @default(uuid())
  userId        String
  problemId     String

  code          String   @db.Text
  language      String   @default("cpp")

  status        String   // 'pending' | 'running' | 'accepted' | 'wrong_answer' | 'time_limit' | 'memory_limit' | 'runtime_error' | 'compile_error'
  score         Int      @default(0)

  compileOutput String?  @db.Text
  runOutput     String?  @db.Text
  errorMessage  String?  @db.Text

  timeUsed      Int?     // 毫秒
  memoryUsed    Int?     // KB

  testResults   Json?    // [{passed: boolean, input: string, expectedOutput: string, actualOutput: string, time: number, memory: number}]

  // AI调试助手
  aiHelpCount   Int      @default(0)  // 该提交请求AI帮助的次数
  aiConversations Json?  // AI调试对话历史 [{promptLevel: number, aiResponse: string, timestamp: string}]

  createdAt     DateTime @default(now())

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem       Problem    @relation(fields: [problemId], references: [id], onDelete: Cascade)
  errorCase     ErrorCase?

  @@map("submissions")
}

model KnowledgePoint {
  id            String   @id @default(uuid())
  name          String
  level         Int      // GESP级别
  category      String   // 分类：'基础语法' | '数据结构' | '算法' | '数学'
  description   String?  @db.Text

  parentId      String?
  parent        KnowledgePoint?  @relation("KnowledgePointHierarchy", fields: [parentId], references: [id])
  children      KnowledgePoint[] @relation("KnowledgePointHierarchy")

  prerequisites String[] @default([])  // 前置知识点ID

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  learningRecords LearningRecord[]

  @@map("knowledge_points")
}

model LearningRecord {
  id               String   @id @default(uuid())
  userId           String
  knowledgePointId String

  status           String   @default("not_started") // 'not_started' | 'in_progress' | 'completed' | 'mastered'
  progress         Int      @default(0)  // 0-100

  startedAt        DateTime?
  completedAt      DateTime?
  lastStudiedAt    DateTime?

  studyTime        Int      @default(0)  // 累计学习时间（分钟）
  practiceCount    Int      @default(0)  // 练习题目数
  correctCount     Int      @default(0)  // 正确题目数

  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  knowledgePoint   KnowledgePoint @relation(fields: [knowledgePointId], references: [id], onDelete: Cascade)

  @@unique([userId, knowledgePointId])
  @@map("learning_records")
}

model StudyPlan {
  id            String   @id @default(uuid())
  userId        String

  startDate     DateTime
  endDate       DateTime
  targetLevel   Int

  weeklyPlan    Json     // 每周计划详情
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_plans")
}

model DailyTask {
  id            String   @id @default(uuid())
  userId        String
  date          DateTime @db.Date

  tasks         Json     // [{type: 'learn' | 'practice', targetId: string, title: string, completed: boolean, xpReward: number}]

  totalXp       Int      @default(0)
  completedXp   Int      @default(0)
  isCompleted   Boolean  @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_tasks")
}

model ChatHistory {
  id            String   @id @default(uuid())
  userId        String

  context       String   // 上下文类型：'learn_知识点ID' | 'problem_题目ID' | 'general'
  messages      Json     // [{role: 'user' | 'assistant', content: string, timestamp: string}]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_histories")
}

model Badge {
  id            String   @id @default(uuid())
  code          String   @unique
  name          String
  description   String
  icon          String   // emoji or icon name
  condition     Json     // 获取条件

  createdAt     DateTime @default(now())

  @@map("badges")
}

// 错题记录
model ErrorCase {
  id            String   @id @default(uuid())
  userId        String
  submissionId  String   @unique  // 关联到失败的提交
  problemId     String

  // 错误分类：'misread'(读错题) | 'boundary'(边界漏) | 'implementation'(写法错) | 'timeout'(太慢了)
  errorType     String?

  // 三问答案（学生填写）
  q1Answer      String?  @db.Text  // 这道题错了哪？
  q2Answer      String?  @db.Text  // 为什么会错？
  q3Answer      String?  @db.Text  // 下次怎么避免？

  // AI分析
  aiAnalysis    Json?    // { classification, hints, suggestedRule }

  // 防错规则
  preventionRuleId String?

  // 状态：'pending' | 'in_progress' | 'completed'
  status        String   @default("pending")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  problem       Problem    @relation(fields: [problemId], references: [id], onDelete: Cascade)
  preventionRule PreventionRule? @relation(fields: [preventionRuleId], references: [id])

  @@map("error_cases")
}

// 防错规则
model PreventionRule {
  id            String   @id @default(uuid())
  userId        String

  errorType     String   // 关联的错误类型
  rule          String   @db.Text  // 防错规则内容
  examples      String[] // 触发案例列表（problemId）

  hitCount      Int      @default(0)  // 再次触发次数
  lastHitAt     DateTime?

  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  errorCases    ErrorCase[]

  @@map("prevention_rules")
}
